<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.css">
  <link rel="stylesheet" href="./datepicker.css">

</head>
<body>

  <div class="m-app">

  </div>
  
  <script id="datepicker2" type="text/tpl">
  <div class="input-group date" id="datetimepicker5">
      <input type="text" class="form-control" disabled value={selected|format: format} >
      <span class="input-group-addon" on-click={show=!show} >
          <span class="glyphicon glyphicon-calendar"></span>
      </span>
  <div r-hide={!show} class="bootstrap-datetimepicker dropdown-menu bottom pull-right" style="display: block; top: 34px; bottom: auto; left: auto; right: 0px;">
  <ul class="list-unstyled">
    <li class="collapse { dateMode && 'in'}">
      <div class="datepicker">
        <div class="datepicker-days" r-hide={monthMode}>
          <table class="table-condensed">
            <thead>
              <tr>
                <th class="prev"  on-click={this.resetDate(year, month-1)}>
                  <span class="glyphicon glyphicon-chevron-left"></span>
                </th>
                <th class="picker-switch" on-click={this.switchMonth(true)}  colspan="5" on>{month +1 } / {year}</th>
                <th class="next"  on-click={this.resetDate(year, month+1)}>
                  <span class="glyphicon glyphicon-chevron-right"></span>
                </th>
              </tr>
              <tr>
                {#list 0..6 as w}
                <th class="dow">{w|i18n: 'week'}</th>
                {/list}
              </tr>
            </thead>
            <tbody>
              {#list grid as row}
              <tr>
                {#list row as item}
                  <td class="day" r-class={{"selected active": item.date===selectedDay, "old": item.disable}}   on-click={this.select(item)}>{item.num}</td>
                {/list}
              </tr>
              {/list}
            </tbody>
          </table>
        </div>
        <div class="datepicker-months" r-hide={!monthMode}>
          <table class="table-condensed">
            <thead>
              <tr>
                <th class="prev" on-click={myear-=1} >
                  <span class="glyphicon glyphicon-chevron-left" ></span>
                </th>
                <th class="picker-switch"  colspan="5">{myear}</th>
                <th class="next" on-click={myear+=1} >
                  <span class="glyphicon glyphicon-chevron-right"></span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7">
                  {#list 1..12 as m}
                    <span  class="month" on-click={[this.resetDate(myear, m-1), this.switchMonth(false)]} r-class={ {"active": this.is(myear, m-1) } } >
                      {m |i18n:'month'}
                      </span>
                  {/list}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </li>
    <li class="picker-switch accordion-toggle" on-click={dateMode=!dateMode}>
      <table class="table-condensed">
        <tbody>
          <tr>
            <td>
              <a >
                <span class="glyphicon glyphicon-time"></span>
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </li>
    <li class="collapse {!dateMode? 'in': ''}">

    </li>
  </ul>
</div>
  </div>

  </script>

  

  <script src="https://rawgit.com/regularjs/regular/master/dist/regular.min.js"></script>
  <script src="./datepicker.js"></script>

  <script>
// http://zh.wikipedia.org/wiki/%E6%98%9F%E6%9C%9F%E7%9A%84%E8%A8%88%E7%AE%97

var mnums = [5, 1, 1, 4, 6, 2, 4, 0, 3, 5, 1, 3];
var dnums = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]


function getDays( year, month ){
  return ( isLeap(year) && month === 2 )? 29 : dnums[month - 1];
}

function isLeap(year){
  return !(year % 4) && ( year % 100 ) || !( year%400 )
}

var Datepicker = Regular.extend({

  template: "#datepicker2",
  config: function(data){
    // initialize the month grid
    var grid = [], i = 6, j = 7;
    for(;i--;){
      grid[i] = [];
      j = 7;
      for(;j--;) {
        grid[i][j] = {num:"1", state: "1"};
      }

    }

    data.grid = grid;
    data.dateMode = data.dateMode || 1;
    var now = new Date(data.time),
      now_month = now.getMonth(),
      now_year = now.getFullYear();

    this.resetDate(now_year, now_month);
    this.resetTime(now.getHours(), now.getMinutes());

  },
  resetDate: function(year, month){
    if(month > 11){
      month = month - 12;
      year +=1;
    }
    if(month < 0){
      year-=1;
      month = month + 12;
    }
    var data = this.data;
    data.month = month;
    data.year = year;

    var start = new Date(year, month, 1),
      monthDays = getDays(year, month),
      sday = start.getDay() ,
      grid = this.data.grid;
      preMonthDays = getDays(year,  (month + 11) % 12 + 1);


    // for(var i =0; i<sday; i++){
    //   grid[0][i].num = preMonthDays - sday + i + 1;
    // }

    // for(var m=sday; m < 7; m++){
    //   grid[0][m].num = m-sday+1;
    // }

    // 初始化
    for(var i = 0; i < grid.length ; i ++){
      for(var j=0; j < 7; j++){
        var num = i * 7 - sday + j + 1 ;
        var disable = false;
        var item = grid[i][j];
        if(num < 1){
          num = num + preMonthDays;
          disable = true;
          item.date = null;
        }else if(num > monthDays) {
          num = num - monthDays;
          disable = true;
          item.date = null;
        }else{
          disable = false;
          item.date = +new Date(year, month, num) ;
        }
        item.num =  num;
        item.disable =  disable;
        
      } 
    }
  },
  resetTime: function(hour, minute){
    var data = this.data;
    hour = parseInt(hour || 0, 10);
    minute = parseInt(minute || 0, 10)
    if(minute > 59){
       minute -= 60
       hour += 1
    }else if(minute < 0){
       minute +=60
       hour -=  1
    }
    if(hour > 23 ){
      hour -= 24; 
    }else if(hour < 0){
      hour += 24; 
    }

    data.hour = hour;
    data.minute = minute;
    this.updateSelected();
  },
  updateSelected: function(){
    var minuteStep = 1000 * 60;
    var data = this.data;
    data.selected = this.data.selectedDay + data.hour * minuteStep * 60 + data.minute * minuteStep;
    this.$update();
  },
  switchMonth: function(flag){
    var data = this.data;
    data.monthMode = flag;
    if(flag) data.myear = data.year;
  },
  select: function(item){
    if(!item || !item.date) return ;
    this.data.selectedDay = item.date;
    this.updateSelected()
  },
  _normalize: function( date ){
    if(!(date instanceof Date)) date = new Date(date);
    return new Date( date.getFullYear(), date.getMonth(), date.getDate());
  },
  _match: function(date, year, month, day){
    if(!date) return false;
    date = new Date(date);
    if(year !=null && date.getFullYear() !== year) return false; 
    if(month !=null && date.getMonth() !== month) return false; 
    if(day !=null && date.getDate() !== day) return false; 
    return true
  },
  is: function(year, month, day){
    return this._match(this.data.selectedDay, year, month, day);
  }

}).filter({
  i18n: function( value, type ){
      var lang = Datepicker.langs["zh"];
      var translator = lang[type || 'normal'];
      return translator && (typeof translator === "function"? translator(value) : translator[value]) || value;
  },
  norm: function(value){
    var str = "" + value;
    return str.length === 1? "0" + str : str;
  }

})

  var format = (function(){
    function fix(str){
      str = "" + (str || "0");
      return str.length <= 1? "0" + str : str;
    }
    var maps = {
      'yyyy': function(date){return date.getFullYear()},
      'MM': function(date){return fix(date.getMonth() + 1); },
      'dd': function(date){ return fix(date.getDate()) },
      'HH': function(date){ return fix(date.getHours()) },
      'mm': function(date){ return fix(date.getMinutes())}
    }

    var trunk = new RegExp(Object.keys(maps).join('|'),'g');
    return function(value, format){
      if(!value) return;
      format = format || "yyyy-MM-dd HH:mm";
      value = new Date(parseInt(value));

      return format.replace(trunk, function(capture){
        return maps[capture]? maps[capture](value): "";
      });
    }
  })();

Regular.filter("format", format);

Datepicker.langs = {
  normal: {

  },
  zh: {
    week: function(value){
      return  ["日", "一", "二", "三", "四", "五", "六"][value];
    },

  }
}





var datepicker = new Datepicker({
  options: { },
  data: {
    time: +new Date + 24 * 4600 * 1000,
    hour: 1,
    minute: 2
  }
}).$inject(".m-app")



// datepicker.$inject(".m-app"); 

// datepicker.$replace()

// Regular.extend({
//   template: "<div>{title}</div>"
// })

// walk("div[ref=1]", function(){
//   return "<div></div>"

//   // or 

//   return Regular.parse("<div></div>")
// })










</script>

</body>


</html>